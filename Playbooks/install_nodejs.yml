---
- name: Install Node.js on Windows with CPU Monitoring
  hosts: windows
  gather_facts: yes
  
  vars:
    nodejs_version: "20.11.1"
    nodejs_installer_url: "https://nodejs.org/dist/v{{ nodejs_version }}/node-v{{ nodejs_version }}-x64.msi"
    temp_dir: "C:\\Temp"
    force_reinstall: false

  pre_tasks:
    - name: Check if Node.js is already installed
      ansible.windows.win_command: node --version
      register: existing_node
      changed_when: false
      failed_when: false

    - name: Display existing Node.js version if found
      ansible.builtin.debug:
        msg: "⚠️ Node.js {{ existing_node.stdout | trim }} sudah terinstall. Set force_reinstall=true untuk uninstall dulu."
      when: existing_node.rc == 0 and not force_reinstall

    - name: Uninstall existing Node.js if force_reinstall enabled
      ansible.windows.win_package:
        product_id: '{5ABA83F0-49A0-42C9-A3E8-47F80193A9AD}'
        state: absent
      when: existing_node.rc == 0 and force_reinstall
      register: uninstall_result
      ignore_errors: yes

    - name: Get baseline CPU usage using WMI (no profile interference)
      ansible.windows.win_shell: |
        $cpu = Get-CimInstance Win32_Processor | Measure-Object -Property LoadPercentage -Average | Select-Object -ExpandProperty Average
        Write-Output $cpu
      args:
        executable: powershell.exe
      environment:
        PSModulePath: ''
      register: baseline_cpu
      changed_when: false

    - name: Get processor count using WMI
      ansible.windows.win_shell: |
        $cores = (Get-CimInstance Win32_ComputerSystem).NumberOfLogicalProcessors
        Write-Output $cores
      args:
        executable: powershell.exe
      environment:
        PSModulePath: ''
      register: cpu_count
      changed_when: false

    - name: Display baseline CPU information
      ansible.builtin.debug:
        msg:
          - "============================================================"
          - "    PLAYBOOK START - Baseline CPU Report"
          - "============================================================"
          - "Host              : {{ inventory_hostname }}"
          - "CPU Usage (Start) : {{ baseline_cpu.stdout | trim }}%"
          - "Total CPU Cores   : {{ cpu_count.stdout | trim }}"
          - "============================================================"
          - ""

  tasks:
    - name: Skip installation if Node.js exists and force_reinstall is false
      ansible.builtin.meta: end_host
      when: existing_node.rc == 0 and not force_reinstall

    - name: Create temp directory if not exists
      ansible.windows.win_file:
        path: "{{ temp_dir }}"
        state: directory

    - name: Start CPU monitoring job in background using WMI
      ansible.windows.win_shell: |
        $samples = 5
        $interval = 1
        $total = 0
        for ($i = 0; $i -lt $samples; $i++) {
          Start-Sleep -Seconds $interval
          $cpu = Get-CimInstance Win32_Processor | Measure-Object -Property LoadPercentage -Average | Select-Object -ExpandProperty Average
          $total += $cpu
        }
        $avg = $total / $samples
        Write-Output $avg
      args:
        executable: powershell.exe
      environment:
        PSModulePath: ''
      async: 30
      poll: 0
      register: cpu_monitor_job
      changed_when: false

    - name: Download Node.js installer
      ansible.windows.win_get_url:
        url: "{{ nodejs_installer_url }}"
        dest: "{{ temp_dir }}\\nodejs-installer.msi"
      register: download_result

    - name: Install Node.js using MSI
      ansible.windows.win_shell: |
        $msiPath = '{{ temp_dir }}\nodejs-installer.msi'
        $logPath = '{{ temp_dir }}\nodejs-install.log'
        $arguments = '/i', $msiPath, '/qn', '/norestart', '/L*V', $logPath
        $process = Start-Process -FilePath 'msiexec.exe' -ArgumentList $arguments -Wait -PassThru -NoNewWindow
        Write-Output $process.ExitCode
      args:
        executable: powershell.exe
      environment:
        PSModulePath: ''
      register: nodejs_install
      changed_when: nodejs_install.stdout | trim == '0'
      failed_when: nodejs_install.stdout | trim not in ['0', '3010']

    - name: Verify Node.js installation
      ansible.windows.win_command: node --version
      register: node_version
      changed_when: false
      failed_when: false

    - name: Wait for CPU monitoring to complete
      ansible.builtin.async_status:
        jid: "{{ cpu_monitor_job.ansible_job_id }}"
      register: cpu_result
      until: cpu_result.finished
      retries: 10
      delay: 3

  post_tasks:
    - name: Get post-install CPU usage using WMI
      ansible.windows.win_shell: |
        $cpu = Get-CimInstance Win32_Processor | Measure-Object -Property LoadPercentage -Average | Select-Object -ExpandProperty Average
        Write-Output $cpu
      args:
        executable: powershell.exe
      environment:
        PSModulePath: ''
      register: post_cpu
      changed_when: false

    - name: Calculate CPU metrics
      ansible.builtin.set_fact:
        baseline_cpu_value: "{{ baseline_cpu.stdout | trim | float | round(2) }}"
        during_avg_cpu: "{{ cpu_result.stdout | trim | float | round(2) }}"
        post_cpu_value: "{{ post_cpu.stdout | trim | float | round(2) }}"
        cpu_delta: "{{ ((post_cpu.stdout | trim | float) - (baseline_cpu.stdout | trim | float)) | round(2) }}"
        total_cores: "{{ cpu_count.stdout | trim | int }}"

    - name: Display detailed CPU usage report
      ansible.builtin.debug:
        msg:
          - "============================================================"
          - "    PLAYBOOK END - Final CPU Report"
          - "============================================================"
          - "Host                  : {{ inventory_hostname }}"
          - ""
          - "CPU BEFORE Playbook   : {{ baseline_cpu_value }}%"
          - "CPU AFTER Playbook    : {{ post_cpu_value }}%"
          - "CPU Delta             : {{ cpu_delta }}% {% if cpu_delta | float > 0 %}(increased){% elif cpu_delta | float < 0 %}(decreased){% else %}(no change){% endif %}"
          - ""
          - "Avg During Install    : {{ during_avg_cpu }}%"
          - "Total CPU Cores       : {{ total_cores }}"
          - ""
          - "Node.js Status        : {% if node_version.rc == 0 %}{{ node_version.stdout | trim }} (SUCCESS){% else %}Installation Failed{% endif %}"
          - "CPU Impact Level      : {% if cpu_delta | float > 20 %}HIGH - Consider optimization{% elif cpu_delta | float > 10 %}MODERATE{% else %}LOW{% endif %}"
          - "============================================================"
          - ""

    - name: Read installation log on failure
      ansible.windows.win_shell: |
        if (Test-Path "{{ temp_dir }}\nodejs-install.log") {
          Get-Content "{{ temp_dir }}\nodejs-install.log" -Tail 50
        }
      args:
        executable: powershell.exe
      environment:
        PSModulePath: ''
      register: install_log
      when: node_version.rc != 0
      ignore_errors: yes

    - name: Display installation log excerpt if failed
      ansible.builtin.debug:
        msg: "{{ install_log.stdout_lines }}"
      when: node_version.rc != 0 and install_log.stdout_lines is defined

    - name: Cleanup installer file
      ansible.windows.win_file:
        path: "{{ temp_dir }}\\nodejs-installer.msi"
        state: absent
      when: download_result is succeeded

    - name: Send aggregate summary
      ansible.builtin.debug:
        msg: "Windows Installation Complete - Avg CPU Impact: {{ cpu_delta }}%"
      run_once: true
      when: inventory_hostname == groups['windows'][-1]
      