---
- name: Verify and Install Common Software on Windows PCs
  hosts: windows
  gather_facts: yes
  
  vars:
    software_list:
      - name: "Google Chrome"
        package: "googlechrome"
      - name: "Visual Studio Code"
        package: "vscode"
      - name: "Python 3"
        package: "python"
      - name: "Notepad++"
        package: "notepadplusplus"
      - name: "Git"
        package: "git"
    
    choco_install_timeout: 3600  # 1 hour timeout for large packages

  pre_tasks:
    - name: Check if Chocolatey is installed
      ansible.windows.win_stat:
        path: "C:\\ProgramData\\chocolatey\\bin\\choco.exe"
      register: choco_check

    - name: Install Chocolatey if not present
      ansible.windows.win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
      args:
        executable: powershell.exe
      environment:
        PSModulePath: ''
      when: not choco_check.stat.exists
      register: choco_install

    - name: Verify Chocolatey installation
      ansible.windows.win_command: choco --version
      register: choco_version
      changed_when: false
      failed_when: choco_version.rc != 0

    - name: Display Chocolatey version
      ansible.builtin.debug:
        msg: "Chocolatey version {{ choco_version.stdout | trim }} is installed"

  tasks:
    - name: Check which software is already installed
      ansible.windows.win_shell: |
        $result = choco list --local-only "{{ item.package }}" --exact --limit-output
        if ($result) {
          Write-Output "INSTALLED"
        } else {
          Write-Output "NOT_INSTALLED"
        }
      args:
        executable: powershell.exe
      environment:
        PSModulePath: ''
      loop: "{{ software_list }}"
      register: software_check
      changed_when: false

    - name: Display software status
      ansible.builtin.debug:
        msg:
          - "============================================================"
          - "    Software Installation Status Check"
          - "============================================================"
          - "{% for result in software_check.results %}{{ result.item.name }}: {{ result.stdout | trim }}{% endfor %}"
          - "============================================================"

    - name: Install missing software
      ansible.windows.win_shell: |
        $ErrorActionPreference = 'Stop'
        try {
          Write-Output "Installing {{ item.item.name }}..."
          $result = choco install "{{ item.item.package }}" -y --no-progress --limit-output --timeout {{ choco_install_timeout }}
          if ($LASTEXITCODE -eq 0) {
            Write-Output "SUCCESS: {{ item.item.name }} installed successfully"
          } else {
            Write-Output "WARNING: {{ item.item.name }} installation returned code $LASTEXITCODE"
          }
        } catch {
          Write-Output "ERROR: Failed to install {{ item.item.name }} - $_"
          exit 1
        }
      args:
        executable: powershell.exe
      environment:
        PSModulePath: ''
      loop: "{{ software_check.results }}"
      when: item.stdout | trim == 'NOT_INSTALLED'
      register: install_results
      retries: 2
      delay: 5
      until: install_results is succeeded
      ignore_errors: yes

    - name: Verify installations
      ansible.windows.win_shell: |
        $result = choco list --local-only '{{ item.item.package }}' --exact --limit-output
        if ($result) {
          $parts = $result -split '\|'
          $version = $parts[-1]
          $output = "INSTALLED|" + $version
          Write-Output $output
        } else {
          Write-Output "FAILED|N/A"
        }
      args:
        executable: powershell.exe
      environment:
        PSModulePath: ''
      loop: "{{ software_check.results }}"
      when: item.stdout | trim == 'NOT_INSTALLED'
      register: verify_results
      changed_when: false

  post_tasks:
    - name: Display final installation summary
      ansible.builtin.debug:
        msg:
          - "============================================================"
          - "    SOFTWARE INSTALLATION SUMMARY - {{ inventory_hostname }}"
          - "============================================================"
          - "{% for result in software_check.results %}{{ result.item.name }}: {% if result.stdout | trim == 'INSTALLED' %}Already Installed{% else %}Newly Installed{% endif %}{% endfor %}"
          - "============================================================"

    - name: Display failed installations if any
      ansible.builtin.debug:
        msg:
          - "============================================================"
          - "    FAILED INSTALLATIONS"
          - "============================================================"
          - "{{ item.item.item.name }}: {{ item.stdout | default('Unknown error') }}"
          - "============================================================"
      loop: "{{ install_results.results }}"
      when: 
        - install_results is defined
        - install_results.results is defined
        - item is failed
      loop_control:
        label: "{{ item.item.item.name }}"

    - name: Send aggregate summary for all hosts
      ansible.builtin.debug:
        msg: "Installation complete on {{ groups['windows'] | length }} Windows host(s)"
      run_once: true
      when: inventory_hostname == groups['windows'][-1]